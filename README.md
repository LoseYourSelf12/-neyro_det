# Нейродетектор для светофорного перекрестка

Этот репозиторий содержит набор утилит для детекции объектов на перекрёстке и выбора оптимальной программы работы светофора. Детекция выполняется моделью YOLOv5 в формате ONNX. Проект включает в себя сервис детекции, примеры работы с видеопотоками, редактор зон интереса и скрипты для эмуляции камер и контроллера.

## Структура

- `config/` – конфигурационные файлы.
- `models/` – ONNX‑модель YOLOv5.
- `masks/` – пример масок/зон для кадрирования изображения.
- `samples/` – тестовые данные (изображения, видео).
- `scripts/` – вспомогательные скрипты, в том числе `mock_controller.py`.
- `src/` – исходный код основного сервиса.
- `demo.py` – демонстрационное приложение PyQt6.
- `drow_zones.py` – графический редактор масок зон.
- `camera_emulator.py` – HTTP‑служба для трансляции видео как RTSP‑потоков.

## Установка зависимостей

Зависимости можно установить через `pip`:

```bash
pip install opencv-python numpy requests onnxruntime fastapi uvicorn PyQt6 ultralytics
```

ONNX‑модель `models/yolov5s.onnx` уже присутствует в репозитории.

## Конфигурация

Основные параметры задаются в файле `config/default.json`:

```json
{
    "controller": {
        "api_base_url": "http://localhost:5000/api",
        "poll_interval_sec": 1,
        "traffic_phase_lead_sec": 2
    },
    "cameras": {
        "1": "rtsp://localhost:8554/cam1",
        "2": "rtsp://localhost:8554/cam1",
        "3": "rtsp://localhost:8554/cam1",
        "4": "rtsp://localhost:8554/cam1"
    },
    "detector": {
        "model_path": "models/yolov5s.onnx",
        "input_size": 640,
        "confidence_threshold": 0.25,
        "nms_threshold": 0.45
    },
    "mask_dir": "masks/",
    "analysis": {
        "shots_per_phase": 3,
        "congestion_threshold": 5,
        "downgrade_cycles": 3
    },
    "logging": {
        "level": "INFO",
        "file": "logs/neyro_det.log",
        "max_bytes": 10485760,
        "backup_count": 5
    }
}
```

При необходимости можно изменить пути к RTSP‑камерам, параметры порогов и масок, а также настройки логирования.

## Запуск основного сервиса

Сервис запускается модулем `src`:

```bash
python -m src
```

Он обращается к контроллеру светофора через HTTP (см. `scripts/mock_controller.py`), получает текущую фазу и в определённые моменты выполняет цикл детекции. Количество машин с каждой стороны сравнивается с порогом, после чего принимается решение о переключении программы.

## Эмуляция контроллера и камер

Для локального тестирования можно запустить скрипт‐эмулятор контроллера:

```bash
python scripts/mock_controller.py
```

Также предусмотрен простой эмулятор камер (`camera_emulator.py`), который с помощью `ffmpeg` зацикливает видеофайлы и отдаёт их по RTSP. Файл `add_cam.txt` содержит примеры команд для добавления камер через HTTP.

Перед запуском камер необходимо запустить RTSP‑сервер `mediamtx.exe` (настройки находятся в `mediamtx.yml`).

## Демонстрационное приложение

Файл `demo.py` реализует GUI‐демонстрацию на PyQt6 с визуализацией зон и статистики по четырём камерам. Для редактирования масок зон можно использовать `drow_zones.py`.

